<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Latitude Margaritaville Hilton Head</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Detect Android WebView mode early to avoid flicker -->
  <script>
    (function () {
      if (window.location.search.indexOf("android=1") !== -1) {
        document.documentElement.classList.add("android-app");
      }
    })();
  </script>

  <style>
    * { box-sizing: border-box; }
    html, body { margin:0; overflow-x:hidden; }

    /* ---------- FIXED HEADER ---------- */
    header.top-bar{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 5000;
      background:#111827;
      color:#f9fafb;
      padding: 10px 12px 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.18);
    }
    header.top-bar .row1{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .app-title{
      font-weight:800;
      font-size:1.05rem;
      white-space:nowrap;
    }
    .top-controls{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:.9rem;
    }
    label.season-toggle{
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
    }
    input[type="checkbox"]{ transform: scale(1.1); }
    .link-button{
      background: none;
      border: none;
      color: #93c5fd;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 2px 4px;
    }
    header.top-bar .row2{
      margin-top:6px;
      display:flex;
      justify-content:center;
    }
    .status-text{
      display:inline-block;
      text-align:center;
      font-weight:800;
      padding:4px 10px;
      border-radius:999px;
      background:#065f46;
      border:1px solid #34d399;
      color:#ecfdf5;
      max-width: 95vw;
      white-space: normal;
      font-size:.78rem;
      line-height:1.1;
    }

    /* Push content below fixed header */
    body{ padding-top: 86px; }

    /* ---------- UNIFIED INFO PANEL (TOP-ANCHORED) ---------- */
    #infoPanel{
      position: fixed;
      left: 8px;
      right: 8px;
      top: 96px;                 /* under header; adjust if header height changes */
      z-index: 20000;

      max-height: calc(100vh - 110px);
      overflow: auto;

      background: rgba(255,255,255,.98);
      border: 1px solid #d1d5db;
      border-radius: 12px;
      box-shadow: 0 12px 22px rgba(0,0,0,.22);
    }
    #infoPanel.hidden{ display:none !important; }

    #infoPanel .info-inner{ padding: 12px; }
    #infoPanel h3{ margin:0 0 6px 0; font-size: 1rem; }
    #infoPanel p{ margin:4px 0; }
    #infoPanel .info-actions{
      display:flex;
      justify-content:flex-end;
      padding-top: 10px;
      gap: 8px;
    }
    #infoCloseBtn{
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
    }

    /* Optional: if your existing popup HTML uses these classes */
    .popup-close{
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-size: .85rem;
    }

    /* ---------- MAIN ---------- */
    main{
      display:flex;
      flex-direction:column;
      padding: 8px;
      gap: 8px;
    }

    /* ---------- MAP WRAPPER ---------- */
    #mapWrapper.map-wrapper{
      position: relative;
      width: 100%;
      max-width: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin: 0 auto;
    }

    #mapCanvas{
      display:block;
      width:auto;
      height:auto;
      max-width:none;
      position: relative;
      z-index: 1;
    }

    /* Sprites must never steal taps */
    #spriteLayer, #spriteLayer * { pointer-events: none !important; }

    #spriteLayer{
      position:absolute;
      inset:0;
      z-index: 9999;
      pointer-events:none;
    }

    .alligator-sprite{
      position:absolute;
      font-size:32px;
      line-height:1;
      transform: translate(-50%, -50%);
      animation: gatorBob 2.4s ease-in-out infinite alternate;
      opacity: 1;
    }
    @keyframes gatorBob{
      0%   { transform: translate(-50%, -50%) translateY(0) rotate(0deg); }
      50%  { transform: translate(-50%, -50%) translateY(-4px) rotate(-4deg); }
      100% { transform: translate(-50%, -50%) translateY(4px) rotate(4deg); }
    }

    /* ---------- DOWNLOAD BAR ---------- */
    #download-bar{ margin: 10px 0; text-align:center; }
    #apkMeta{ margin-top: 6px; font-size: .75rem; color:#374151; }

    /* ---------- PRIVACY MODAL ---------- */
    .privacy-panel{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 10000;
    }
    .privacy-panel.hidden{ display:none; }
    .privacy-content{
      background:#fff;
      max-width: 600px;
      width: 90%;
      padding: 16px 20px;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y:auto;
      font-size: .9rem;
    }
    .privacy-content h2{ margin-top:0; margin-bottom: 8px; }
    .privacy-content ul{ padding-left: 20px; }
    .privacy-content button{ margin-top: 12px; padding: 4px 10px; font-size: .85rem; }

    footer{
      padding: 6px 10px;
      font-size: .75rem;
      text-align:center;
      color:#6b7280;
    }

    /* ---------- ANDROID APP MODE ---------- */
    .android-app #download-bar,
    .android-app #android-instructions,
    .android-app #ios-instructions{
      display:none !important;
    }
  </style>
</head>

<body>
  <header class="top-bar">
    <div class="row1">
      <div class="app-title">Phase 7</div>

      <div class="top-controls">
        <label class="season-toggle">
          <input type="checkbox" id="seasonOnlyCheckbox" />
          <span id="seasonOnlyLabel">Residents</span>
        </label>
        <button id="privacyButton" class="link-button">Privacy</button>
      </div>
    </div>

    <div class="row2">
      <span id="lockStatus" class="status-text">Latitude Margaritaville Hilton Head</span>
    </div>
  </header>

  <!-- Unified Info Panel (lots + events + scenes) -->
  <div id="infoPanel" class="hidden" aria-hidden="true">
    <div class="info-inner">
      <div id="infoBody"></div>
      <div class="info-actions">
        <button id="infoCloseBtn" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Download buttons (hidden in Android app via .android-app class) -->
  <div id="download-bar">
    <a
      id="apkDownloadButton"
      href="https://github.com/chuckrushphase7/Phase7Data/releases/download/v1.0.0/Phase7Residents.apk"
      style="
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid #2563eb;
        background: #2563eb;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        margin-right: 8px;
        text-decoration: none;
        display: inline-block;
      ">
      Download Android App
    </a>

    <button
      onclick="document.getElementById('ios-instructions')?.scrollIntoView({ behavior: 'smooth' });"
      style="
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid #6b7280;
        background: white;
        color: #374151;
        font-size: 0.9rem;
        cursor: pointer;
      ">
      iPhone / iPad Instructions
    </button>

    <div id="apkMeta">
      <span style="opacity:0.9;">Latest Android build:</span>
      <strong id="apkBuildLabel">Loading...</strong>
    </div>
  </div>

  <main>
    <div class="map-wrapper" id="mapWrapper">
      <canvas id="mapCanvas"></canvas>
      <div id="spriteLayer"></div>
    </div>

    <!-- Android install instructions (hidden in Android app) -->
    <section id="android-instructions" style="margin: 20px auto; max-width: 600px; padding: 12px 16px; border-top: 1px solid #e5e7eb;">
      <h2 style="font-size: 1.1rem; margin-bottom: 8px; text-align: center;">Installing the Android App</h2>
      <p style="font-size: 0.9rem; margin-bottom: 6px;">
        The Android version of the Phase 7 Neighborhood Map is installed from an <code>.apk</code> file.
      </p>
      <ol style="font-size: 0.88rem; padding-left: 20px; line-height: 1.4;">
        <li>Tap <strong>Download Android App</strong> above.</li>
        <li>Confirm any warning prompts.</li>
        <li>Open the downloaded <code>Phase7Residents.apk</code> and install.</li>
      </ol>
    </section>

    <!-- iOS instructions (hidden in Android app) -->
    <section id="ios-instructions" style="margin: 20px auto; max-width: 600px; padding: 12px 16px; border-top: 1px solid #e5e7eb;">
      <h2 style="font-size: 1.1rem; margin-bottom: 8px; text-align: center;">Using Phase 7 on iPhone / iPad</h2>
      <ol style="font-size: 0.88rem; padding-left: 20px; line-height: 1.4;">
        <li>Open this page in Safari.</li>
        <li>Tap <strong>Share</strong>.</li>
        <li>Choose <strong>Add to Home Screen</strong>.</li>
      </ol>
    </section>
  </main>

  <footer>
    This map is for Phase 7 residents. Seasonal view hides personal information by default.
  </footer>

  <!-- Privacy modal -->
  <div id="privacyPanel" class="privacy-panel hidden">
    <div class="privacy-content">
      <h2>Privacy &amp; Data Use</h2>
      <p>This map is provided for residents of Phase 7 for neighborhood reference and seasonal displays.</p>
      <ul>
        <li>By default, the map only shows seasonal stations.</li>
        <li>Personal details are hidden in the default view.</li>
      </ul>
      <button id="privacyCloseButton">Close</button>
    </div>
  </div>

  <!-- Data and logic files -->
  <script src="phase7_merged_lots.js"></script>
  <script src="mapped_sites.js"></script>
  <script src="apk_info.js"></script>
  <script src="events.js"></script>
  <script src="draw_sites.js"></script>
  <script src="event_engine.js"></script>
  <script src="draw_lots.js"></script>
  <script src="map_core.js"></script>

  <!-- Populate APK build label -->
  <script>
    (function () {
      var el = document.getElementById("apkBuildLabel");
      if (!el) return;

      if (typeof apkInfo !== "undefined" && apkInfo && apkInfo.buildDate) {
        var tag = apkInfo.tag ? (" (" + apkInfo.tag + ")") : "";
        el.textContent = apkInfo.buildDate + tag;
      } else {
        el.textContent = "Unknown";
      }
    })();
  </script>
</body>
</html>
