// map_core.js
// Core Phase 7 app logic: state, popups, map init, APK button.

let PASSWORD = "Rudolf122025";
let currentSeasonName = "Holiday Season";

let isSeasonOnly = true;
let isUnlocked = false;

let canvas, ctx, mapImg, mapWrapper;

// LOTS from phase7_merged_lots.js
const LOTS = (typeof phaseResidentsData !== "undefined") ? phaseResidentsData : [];

// ------------------------
// Season / lock UI
// ------------------------
function updateLockStatusUI() {
  const el = document.getElementById("lockStatus");
  if (!el) return;
  el.textContent = isUnlocked
    ? "Full map unlocked (session only)"
    : "Season view only (privacy mode)";
}

// ------------------------
// Fetch season + password (web only)
// ------------------------
function fetchSeasonName() {
  fetch("season_name.txt")
    .then(function (r) { return r.text(); })
    .then(function (text) {
      const trimmed = text.trim();
      if (trimmed) currentSeasonName = trimmed;
    })
    .catch(function (err) {
      console.warn("Could not load season_name.txt, using default.", err);
    });
}

function fetchPassword() {
  fetch("phase7_password.txt")
    .then(function (r) { return r.text(); })
    .then(function (text) {
      const trimmed = text.trim();
      if (trimmed) PASSWORD = trimmed;
    })
    .catch(function (err) {
      console.warn("Could not load phase7_password.txt, using default.", err);
    });
}

// ------------------------
// APK label + download
// ------------------------
function updateApkButtonLabel() {
  if (typeof APK_LAST_UPDATED === "undefined") return;
  const btn = document.getElementById("apkDownloadButton");
  if (!btn) return;
  btn.textContent = "Download Android App (" + APK_LAST_UPDATED + ")";
}

function handleAndroidDownloadClick() {
  // Always use the public GitHub Pages URL for the APK
  window.location.href = "https://chuckrushphase7.github.io/Phase7Data/Phase7Residents.apk";
}
window.handleAndroidDownloadClick = handleAndroidDownloadClick;

// ------------------------
// Privacy panel
// ------------------------
function setupPrivacyPanel() {
  const btn = document.getElementById("privacyButton");
  const panel = document.getElementById("privacyPanel");
  const closeBtn = document.getElementById("privacyCloseButton");

  if (!btn || !panel || !closeBtn) return;

  btn.addEventListener("click", function () {
    panel.classList.remove("hidden");
  });

  closeBtn.addEventListener("click", function () {
    panel.classList.add("hidden");
  });

  panel.addEventListener("click", function (e) {
    if (e.target === panel) panel.classList.add("hidden");
  });
}

// ------------------------
// Season filtering helpers
// ------------------------
function isSeasonStation(lotOrEvent) {
  return !!lotOrEvent && !!lotOrEvent.seasonStation;
}

function getSeasonDetails(lotOrEvent) {
  return lotOrEvent && lotOrEvent.seasonDetails
    ? lotOrEvent.seasonDetails
    : "";
}

// Determine if this lot should be shown for the current view state
function shouldShowLot(lot) {
  if (!lot) return false;

  // Hide entirely if flagged not visible
  if (lot.hideOnMap) return false;

  if (!isUnlocked) {
    // In locked mode:
    // - If Season Only, only show season stations.
    // - If not, still show all lots for geometry.
    return isSeasonOnly ? isSeasonStation(lot) : true;
  }

  // Unlocked view:
  if (isSeasonOnly) {
    return isSeasonStation(lot);
  }

  // Full mode: show everything that's not explicitly hidden
  return true;
}

// ------------------------
// Map + drawing
// ------------------------
function initCanvasAndImage() {
  canvas = document.getElementById("mapCanvas");
  mapWrapper = document.getElementById("mapWrapper");

  if (!canvas || !mapWrapper) {
    console.error("Canvas or mapWrapper not found in DOM.");
    return false;
  }

  ctx = canvas.getContext("2d");
  mapImg = new Image();
  mapImg.src = "Phase7Org.png";

  mapImg.onload = function () {
    console.log("Map image loaded:", mapImg.width, "x", mapImg.height);
    redrawMap();
  };

  mapImg.onerror = function (err) {
    console.error("Failed to load Phase7Org.png", err);
  };

  return true;
}

function resizeCanvasToWrapper() {
  if (!canvas || !mapWrapper) return;
  const rect = mapWrapper.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
}

function drawMapBase() {
  if (!ctx || !mapImg) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const imgW = mapImg.width;
  const imgH = mapImg.height;
  const canvasW = canvas.width;
  const canvasH = canvas.height;

  if (!imgW || !imgH || !canvasW || !canvasH) return;

  const imgAspect = imgW / imgH;
  const canvasAspect = canvasW / canvasH;

  let drawW, drawH, offsetX, offsetY;

  if (imgAspect > canvasAspect) {
    drawW = canvasW;
    drawH = canvasW / imgAspect;
    offsetX = 0;
    offsetY = (canvasH - drawH) / 2;
  } else {
    drawH = canvasH;
    drawW = canvasH * imgAspect;
    offsetX = (canvasW - drawW) / 2;
    offsetY = 0;
  }

  ctx.drawImage(mapImg, offsetX, offsetY, drawW, drawH);
}

function lotToCanvasCoords(lot) {
  if (!lot || !canvas || !mapImg) return null;

  const imgW = mapImg.width;
  const imgH = mapImg.height;
  const canvasW = canvas.width;
  const canvasH = canvas.height;

  if (!imgW || !imgH || !canvasW || !canvasH) return null;

  const imgAspect = imgW / imgH;
  const canvasAspect = canvasW / canvasH;

  let drawW, drawH, offsetX, offsetY;
  if (imgAspect > canvasAspect) {
    drawW = canvasW;
    drawH = canvasW / imgAspect;
    offsetX = 0;
    offsetY = (canvasH - drawH) / 2;
  } else {
    drawH = canvasH;
    drawW = canvasH * imgAspect;
    offsetX = (canvasW - drawW) / 2;
    offsetY = 0;
  }

  const nx = Number(lot.mapX || lot.x) / 1000;
  const ny = Number(lot.mapY || lot.y) / 1000;

  return {
    x: offsetX + nx * drawW,
    y: offsetY + ny * drawH
  };
}

function drawLots() {
  if (!ctx || !Array.isArray(LOTS)) return;

  ctx.save();
  LOTS.forEach(function (lot) {
    if (!shouldShowLot(lot)) return;

    const coords = lotToCanvasCoords(lot);
    if (!coords) return;

    const r = isSeasonStation(lot) ? 6 : 3;
    const color = isSeasonStation(lot) ? "#ff6600" : "#0080ff";

    ctx.beginPath();
    ctx.arc(coords.x, coords.y, r, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
  });
  ctx.restore();
}

// ------------------------
// Popup content builders
// ------------------------
function getSeasonIcon(name) {
  const lower = (name || "").toLowerCase();
  if (lower.indexOf("holiday") !== -1) return "üéÑ";
  if (lower.indexOf("halloween") !== -1) return "üéÉ";
  if (lower.indexOf("summer") !== -1) return "‚òÄÔ∏è";
  return "‚≠ê";
}

function buildEventPopupContent(ev) {
  const parts = [];

  const title = ev.title || (currentSeasonName + " Station");
  const icon = getSeasonIcon(currentSeasonName);

  parts.push("<h3>" + icon + " " + title + "</h3>");

  if (ev.description) {
    parts.push("<p>" + ev.description + "</p>");
  }

  if (ev.host) {
    parts.push("<p><strong>Hosts:</strong> " + ev.host + "</p>");
  }

  if (ev.time) {
    parts.push("<p><strong>Time:</strong> " + ev.time + "</p>");
  }

  parts.push(
    '<button class="popup-close" onclick="hidePopup()">Close</button>'
  );

  return '<div class="popup-inner">' + parts.join("") + "</div>";
}

function buildPopupContent(lot) {
  const seasonDetails = getSeasonDetails(lot);

  // Locked view
  if (!isUnlocked) {
    if (isSeasonStation(lot)) {
      return (
        '<div class="popup-inner">' +
        "<h3>" + currentSeasonName + " Station</h3>" +
        (seasonDetails ? "<p>" + seasonDetails + "</p>" : "") +
        '<button class="popup-close" onclick="hidePopup()">Close</button>' +
        "</div>"
      );
    }
    return (
      '<div class="popup-inner">' +
      "<h3>" + currentSeasonName + " Map</h3>" +
      '<button class="popup-close" onclick="hidePopup()">Close</button>' +
      "</div>"
    );
  }

  // Full details view
  const parts = [];

  parts.push("<h3>Lot " + lot.lotNumber + "</h3>");

  var pName = lot.primaryName || "";
  var sName = lot.secondaryName || "";
  if (pName) {
    parts.push(
      "<p><strong>" +
      (sName ? (pName + " & " + sName) : pName) +
      "</strong></p>"
    );
  }

  if (lot.address) parts.push("<p>" + lot.address + "</p>");
  if (lot.homeTypeStyle) parts.push("<p>Home: " + lot.homeTypeStyle + "</p>");
  if (lot.contractStatus) parts.push("<p>Status: " + lot.contractStatus + "</p>");

  if (lot.isSensitive) {
    parts.push("<p><em>Details limited for privacy.</em></p>");
  } else {
    if (lot.originCityState) {
      parts.push("<p>From: " + lot.originCityState + "</p>");
    }
    if (lot.phone) {
      parts.push("<p>Phone: " + lot.phone + "</p>");
    }
    if (lot.notes) {
      parts.push("<p>Notes: " + lot.notes + "</p>");
    }
  }

  if (isSeasonStation(lot) && seasonDetails) {
    parts.push(
      "<p><strong>" + currentSeasonName +
      " Station:</strong> " + seasonDetails + "</p>"
    );
  }

  parts.push(
    '<button class="popup-close" onclick="hidePopup()">Close</button>'
  );

  return '<div class="popup-inner">' + parts.join("") + "</div>";
}

function hidePopup() {
  const popup = document.getElementById("lotPopup");
  if (!popup) return;
  popup.classList.add("hidden");
  popup.classList.remove("visible");
}
window.hidePopup = hidePopup;

// ------------------------
// Hit testing + tap handling
// ------------------------
function findLotAt(x, y) {
  const threshold = 25;
  const thresholdSq = threshold * threshold;
  let best = null;
  let bestDist = thresholdSq;

  if (!Array.isArray(LOTS)) return null;

  LOTS.forEach(function (lot) {
    if (!shouldShowLot(lot)) return;

    const lx = Number(lot.x);
    const ly = Number(lot.y);
    if (isNaN(lx) || isNaN(ly)) return;

    const dx = lx - x;
    const dy = ly - y;
    const d2 = dx * dx + dy * dy;
    if (d2 < bestDist) {
      bestDist = d2;
      best = lot;
    }
  });

  return best;
}

function showLotPopup(lot, clientX, clientY) {
  const popup = document.getElementById("lotPopup");
  if (!popup || !canvas || !mapWrapper) return;

  const wrapperRect = mapWrapper.getBoundingClientRect();
  const canvasRect = canvas.getBoundingClientRect();

  popup.innerHTML = buildPopupContent(lot);
  popup.classList.remove("hidden");
  popup.classList.add("visible");

  const offsetX = canvasRect.left - wrapperRect.left;
  const offsetY = canvasRect.top - wrapperRect.top;

  let left = (clientX - canvasRect.left) + offsetX + 12;
  let top  = (clientY - canvasRect.top)  + offsetY + 12;

  popup.style.left = left + "px";
  popup.style.top  = top  + "px";

  const popupRect = popup.getBoundingClientRect();

  if (window.innerWidth <= 768) {
    left = (wrapperRect.width - popupRect.width) / 2;
  }

  const maxLeft = wrapperRect.width - popupRect.width - 8;
  const maxTop  = wrapperRect.height - popupRect.height - 8;

  if (left < 8) left = 8;
  if (left > maxLeft) left = maxLeft;
  if (top < 8) top = 8;
  if (top > maxTop) top = maxTop;

  popup.style.left = left + "px";
  popup.style.top  = top  + "px";
}

function showEventPopup(ev, clientX, clientY) {
  const popup = document.getElementById("lotPopup");
  if (!popup || !canvas || !mapWrapper) return;

  const wrapperRect = mapWrapper.getBoundingClientRect();
  const canvasRect = canvas.getBoundingClientRect();

  popup.innerHTML = buildEventPopupContent(ev);
  popup.classList.remove("hidden");
  popup.classList.add("visible");

  const offsetX = canvasRect.left - wrapperRect.left;
  const offsetY = canvasRect.top - wrapperRect.top;

  let left = (clientX - canvasRect.left) + offsetX + 12;
  let top  = (clientY - canvasRect.top)  + offsetY + 12;

  popup.style.left = left + "px";
  popup.style.top  = top  + "px";

  const popupRect = popup.getBoundingClientRect();

  if (window.innerWidth <= 768) {
    left = (wrapperRect.width - popupRect.width) / 2;
  }

  const maxLeft = wrapperRect.width - popupRect.width - 8;
  const maxTop  = wrapperRect.height - popupRect.height - 8;

  if (left < 8) left = 8;
  if (left > maxLeft) left = maxLeft;
  if (top < 8) top = maxTop;

  popup.style.left = left + "px";
  popup.style.top  = top  + "px";
}

function handleCanvasTap(clientX, clientY) {
  if (!canvas || !mapWrapper) return;

  const rect = canvas.getBoundingClientRect();
  const x = clientX - rect.left;
  const y = clientY - rect.top;

  const lot = findLotAt(x, y);

  if (lot) {
    showLotPopup(lot, clientX, clientY);
  } else {
    hidePopup();
  }
}

function setupCanvasEvents() {
  if (!canvas) return;

  canvas.addEventListener("click", function (e) {
    handleCanvasTap(e.clientX, e.clientY);
  });

  canvas.addEventListener("touchend", function (e) {
    if (e.changedTouches && e.changedTouches.length > 0) {
      const t = e.changedTouches[0];
      handleCanvasTap(t.clientX, t.clientY);
    }
  });
}

// ------------------------
// Redraw
// ------------------------
function redrawMap() {
  if (!canvas || !ctx) return;
  resizeCanvasToWrapper();
  drawMapBase();
  drawLots();
}

// ------------------------
// Season toggle + unlock
// ------------------------
function setupSeasonToggle() {
  const checkbox = document.getElementById("seasonOnlyCheckbox");
  if (!checkbox) return;

  checkbox.addEventListener("change", function () {
    if (!isUnlocked && !checkbox.checked) {
      const entered = window.prompt("Enter password to unlock full map:");
      if (entered === PASSWORD) {
        isUnlocked = true;
        isSeasonOnly = false;
      } else {
        alert("Incorrect password. Staying in seasonal privacy mode.");
        checkbox.checked = true;
        isSeasonOnly = true;
      }
      updateLockStatusUI();
      drawLots();
      return;
    }

    isSeasonOnly = checkbox.checked;
    updateLockStatusUI();
    drawLots();
  });
}

// ------------------------
// Map init
// ------------------------
function initMap() {
  if (!initCanvasAndImage()) return;

  window.addEventListener("resize", function () {
    redrawMap();
  });

  setupCanvasEvents();
}

// ------------------------
// Startup
// ------------------------
window.addEventListener("load", function () {
  updateLockStatusUI();
  updateApkButtonLabel();

  const isWeb =
    window.location.protocol === "http:" ||
    window.location.protocol === "https:";

  if (isWeb) {
    fetchSeasonName();
    fetchPassword();
  } else {
    console.warn("Running from file:// - skipping season/password fetch.");
  }

  setupPrivacyPanel();
  setupSeasonToggle();
  initMap();
});
